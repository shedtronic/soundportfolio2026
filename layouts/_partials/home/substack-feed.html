{{/* Load feed URL from config */}}
{{ $url := .Site.Params.substackFeed }}
{{ $limit := .Site.Params.substackLimit | default 4 }}

{{ if $url }}
<div class="substack-grid-wrapper">

    {{ with resources.GetRemote $url | transform.Unmarshal }}

    {{/* 1. Normalise dates so Hugo can parse them reliably */}}
    {{ $items := slice }}
    {{ range .channel.item }}
        {{ $parsed := dict 
            "title" .title
            "link" .link
            "encoded" .encoded
            "enclosure" .enclosure
            "pub" (time .pubDate)
        }}
        {{ $items = $items | append $parsed }}
    {{ end }}

    {{/* 2. Sort newest â†’ oldest */}}
    {{ $sorted := sort $items "pub" "desc" }}

    {{/* 3. Take the first N items */}}
    {{ $posts := first $limit $sorted }}

    <div class="substack-grid">
        {{ range $posts }}

        {{/* Extract excerpt */}}
        {{ $excerpt := .encoded | safeHTML | plainify | truncate 140 }}

        {{/* Try enclosure image */}}
        {{ $img := "" }}
        {{ with .enclosure }}
            {{ $img = index . "url" }}
        {{ end }}

        {{/* Fallback: first <img> in encoded HTML */}}
        {{ if not $img }}
            {{ $found := findRE `img.*src="([^"]+)"` (.encoded | safeHTML) 1 }}
            {{ if $found }}
                {{ $img = replaceRE `.*src="([^"]+)".*` "$1" (index $found 0) }}
            {{ end }}
        {{ end }}

        {{/* Final fallback */}}
        {{ if not $img }}
            {{ $img = "/images/substack-placeholder.png" }}
        {{ end }}

        <div class="substack-card" onclick="window.location='{{ .link }}'">
            <div class="substack-card-image">
                <img src="{{ $img }}" alt="{{ .title }}">
            </div>

            <div class="substack-card-content">
                <h3 class="substack-card-title">{{ .title }}</h3>
                <p class="substack-card-excerpt">{{ $excerpt }}</p>
                <p class="substack-card-date">{{ dateFormat "02 Jan 2006" .pub }}</p>
            </div>
        </div>

        {{ end }}
    </div>

    {{ end }}
</div>
{{ end }}
